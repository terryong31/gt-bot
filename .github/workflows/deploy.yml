name: Deploy Bot to VPS

on: 
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"
  workflow_dispatch:

concurrency:
  group: production-deployment
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          envs: GH_PAT
          script: |
            # Helper for sudo commands (assuming passwordless sudo for ubuntu user)
            do_sudo() {
              sudo "$@"
            }

            # Setup directory (running as logged-in user)
            DIR="/opt/telegram-bot"
            
            # Create directory if not exists (using sudo if needed)
            if [ ! -d "$DIR" ]; then
              do_sudo mkdir -p "$DIR"
              do_sudo chown -R $USER:$USER "$DIR"
            fi
            
            cd "$DIR"
            
            # Fix git ownership issue (prevents "dubious ownership" error)
            git config --global --add safe.directory "$DIR" 2>/dev/null || true
            
            # Robust git handling
            if [ -d ".git" ]; then
              git fetch origin
              git reset --hard origin/main
              git clean -fd
            else
              git clone https://$GH_PAT@github.com/EASAcademy/telegram-bot.git .
            fi
            
            # Create data directories
            mkdir -p data/uploads
            
            # Backup database
            cp data/bot.db data/bot.db.bak || true
            
            # Deploy Containers (assuming user is in docker group, else try sudo)
            if groups | grep -q 'docker'; then
              docker compose -f docker/docker-compose.yml down
              docker compose -f docker/docker-compose.yml up -d --build --remove-orphans
              docker system prune -f
            else
               do_sudo docker compose -f docker/docker-compose.yml down
               do_sudo docker compose -f docker/docker-compose.yml up -d --build --remove-orphans
               do_sudo docker system prune -f
            fi
            
            echo "âœ… Deployment successful! Please configure Caddy locally: 'gt-bot.terryong.me { reverse_proxy localhost:8080 }'"